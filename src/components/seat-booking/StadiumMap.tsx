import React, { useEffect, useRef, useMemo } from 'react';
import { galleryData } from '@/data/galleryData';

interface StadiumMapProps {
  selectedGalleryId: string;
  selectedLevel: string;
  onGalleryClick: (galleryId: string, level: string) => void;
}

const DEFAULT_COLOR = '#A1A1AA';
const HIGHLIGHT_COLOR = '#00E5FF';

export const StadiumMap: React.FC<StadiumMapProps> = ({ selectedGalleryId, selectedLevel, onGalleryClick }) => {
  const svgRef = useRef<SVGSVGElement>(null);

  const pathIdToGalleryMap = useMemo(() => {
    const map = new Map<string, { galleryId: string, level: string }>();
    galleryData.forEach(gallery => {
      Object.entries(gallery.svgPathIds).forEach(([level, pathIds]) => {
        pathIds.forEach(pathId => {
          map.set(pathId, { galleryId: gallery.id, level });
        });
      });
    });
    return map;
  }, []);

  useEffect(() => {
    if (!svgRef.current) return;
    
    // 1. Reset all gallery paths to default color and set cursor
    pathIdToGalleryMap.forEach((_, pathId) => {
        const element = svgRef.current?.querySelector(`#${pathId}`);
        if (element) {
          const pathElement = element as SVGPathElement;
          pathElement.style.fill = DEFAULT_COLOR;
          pathElement.style.cursor = 'pointer';
        }
    });

    // 2. Highlight the selected gallery's paths
    const selectedGallery = galleryData.find(g => g.id === selectedGalleryId);
    if (selectedGallery) {
      const levelToHighlight = selectedGallery.levels.length === 1 ? selectedGallery.levels[0] : selectedLevel;
      const pathIdsToHighlight = selectedGallery.svgPathIds[levelToHighlight] || [];

      pathIdsToHighlight.forEach(pathId => {
        const element = svgRef.current?.querySelector(`#${pathId}`);
        if (element) {
          (element as SVGPathElement).style.fill = HIGHLIGHT_COLOR;
        }
      });
    }
  }, [selectedGalleryId, selectedLevel, pathIdToGalleryMap]);

  const handleMapClick = (event: React.MouseEvent<SVGSVGElement>) => {
    const path = event.target as SVGPathElement;
    if (path && path.id) {
        const galleryInfo = pathIdToGalleryMap.get(path.id);
        if (galleryInfo) {
            onGalleryClick(galleryInfo.galleryId, galleryInfo.level);
        }
    }
  };


  return (
    <div className="w-full h-full flex justify-center items-center">
      <svg ref={svgRef} onClick={handleMapClick} width="100%" height="100%" viewBox="0 0 560 450" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clipPath="url(#clip0_4286_52860)">
          <rect x="102" y="374" width="298" height="355" rx="149" transform="rotate(-90 102 374)" fill="#678E3C"></rect>
          <rect x="102" y="374" width="298" height="355" rx="149" transform="rotate(-90 102 374)" stroke="var(--color-surface)" strokeWidth="2"></rect>
          <path opacity="0.2" d="M305.202 151.145H252.044C211.523 151.145 178.675 183.993 178.675 224.514C178.675 265.034 211.523 297.883 252.044 297.883H305.202C345.722 297.883 378.571 265.034 378.571 224.514C378.571 183.993 345.722 151.145 305.202 151.145Z" stroke="white" strokeWidth="2" strokeMiterlimit="10"></path>
          <g opacity="0.4">
            <rect x="235.338" y="239.123" width="27.6041" height="83.1157" rx="4" transform="rotate(-90 235.338 239.123)" fill="white"></rect>
          </g>
          <g clipPath="url(#clip1_4286_52860)">
            <path d="M127.798 55.7821C128.926 57.7169 128.244 60.1975 126.312 61.3306C122.021 63.8469 117.838 66.5315 113.774 69.3734C112.025 70.5961 109.621 70.2839 108.28 68.6238L94.8183 51.9484C93.3581 50.1396 93.7402 47.4684 95.6776 46.1838C100.978 42.6694 106.446 39.3874 112.065 36.351C113.939 35.3379 116.269 36.0174 117.343 37.8579L127.798 55.7821Z" fill="#E9ECF1"></path>
            <path d="M141.896 79.9529C143.027 81.8903 142.341 84.3742 140.407 85.5114C137.33 87.3214 134.318 89.2302 131.373 91.2377C129.621 92.4321 127.236 92.1132 125.904 90.4636L114.927 76.8716C113.491 75.0931 113.833 72.4711 115.71 71.1666C119.612 68.4554 123.625 65.892 127.737 63.4797C129.618 62.3762 132.025 63.0362 133.124 64.9196L141.896 79.9529Z" fill="#E9ECF1"></path>
            <path d="M559.795 224.249C559.795 247.098 556.184 269.123 549.503 289.771C548.823 291.874 546.542 292.982 544.454 292.262L517.319 282.906C515.264 282.198 514.155 279.979 514.774 277.895C519.822 260.88 522.534 242.873 522.534 224.249C522.534 203.645 519.217 183.799 513.092 165.221C512.401 163.125 513.486 160.843 515.566 160.105L542.484 150.549C544.538 149.82 546.801 150.867 547.531 152.921C555.469 175.238 559.795 199.244 559.795 224.249Z" fill="#E9ECF1"></path>

            <path id="internationalLoungeSouthCorporateBlock_southSide3rdFloor_upper" d="M32.8455 224.249C32.8455 233.786 33.5556 243.155 34.9328 252.314C35.2615 254.5 33.8034 256.569 31.6246 256.943L7.02869 261.161C4.86228 261.533 2.79803 260.087 2.45179 257.917C0.702032 246.947 -0.205078 235.706 -0.205078 224.249C-0.205078 206.836 1.8933 189.897 5.84495 173.689C6.37459 171.517 8.61083 170.244 10.7625 170.853L34.6804 177.615C36.7598 178.203 37.9918 180.335 37.5125 182.442C34.4538 195.89 32.8455 209.891 32.8455 224.249Z" fill="#D0D7E1"></path>
            <path id="internationalGallerySouthCorporateBlock_de_lower" d="M60.8721 224.249C60.8721 232.171 61.4439 239.962 62.5556 247.574C62.875 249.761 61.4178 251.829 59.2398 252.203L42.0546 255.151C39.8784 255.524 37.8068 254.065 37.4793 251.881C36.1265 242.862 35.4287 233.634 35.4287 224.249C35.4287 210.213 36.991 196.539 39.9419 183.39C40.4369 181.185 42.6939 179.878 44.869 180.493L61.685 185.254C63.7546 185.84 64.9851 187.956 64.5279 190.058C62.1312 201.076 60.8721 212.517 60.8721 224.249Z" fill="#D0D7E1"></path>
            <path id="clubhousesouthSaheedMushtaqStand_abc_1" d="M105.989 69.8997C107.413 71.662 107.087 74.2505 105.305 75.649C74.4136 99.8909 51.2381 133.533 40.126 172.239C39.5087 174.389 37.2798 175.665 35.1274 175.057L11.3488 168.335C9.23037 167.737 7.99043 165.537 8.61865 163.427C22.0329 118.374 49.9589 79.5147 86.9375 52.286C88.6386 51.0334 91.0178 51.3644 92.3452 53.0078L105.989 69.8997Z" fill="#D0D7E1"></path>
            <path id="clubhousesouthSaheedMushtaqStand_abc_2" d="M123.567 91.6815C124.995 93.4515 124.658 96.0512 122.866 97.4512C96.4403 118.091 76.6125 146.8 67.1045 179.845C66.4846 181.999 64.252 183.284 62.0946 182.674L45.3179 177.931C43.2192 177.338 41.9782 175.171 42.5784 173.074C53.5486 134.745 76.5176 101.435 107.144 77.4745C108.841 76.1474 111.28 76.4553 112.633 78.1314L123.567 91.6815Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_upper_1" d="M228.556 10.8213C230.766 10.8213 232.556 12.6121 232.556 14.8213V17.5023C232.556 19.7115 230.766 21.5023 228.556 21.5023H216.709C185.79 21.5023 155.298 29.0945 128.174 43.5039C126.249 44.5269 123.846 43.874 122.748 41.9902L119.883 37.0756C118.721 35.0824 119.479 32.519 121.561 31.5249C149.351 18.2565 180.431 10.8213 213.222 10.8213H228.556Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_upper_2" d="M228.557 24.0854C230.766 24.0854 232.557 25.8763 232.557 28.0854V31.4381C232.557 33.6472 230.766 35.4381 228.557 35.4381H221.075C190.293 35.537 161.215 43.0314 135.54 56.2449C133.62 57.2331 131.25 56.5715 130.162 54.7058L128.082 51.1366C126.955 49.2034 127.631 46.7177 129.608 45.67C156.3 31.5256 186.304 24.0854 216.709 24.0854H228.557Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_upper_3" d="M291.855 10.8213H260.618C258.409 10.8213 256.618 12.6121 256.618 14.8213V17.5023C256.618 19.7115 258.409 21.5023 260.618 21.5023H291.855C294.064 21.5023 295.855 19.7115 295.855 17.5023V14.8213C295.855 12.6121 294.064 10.8213 291.855 10.8213Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_upper_4" d="M291.855 24.0854H260.618C258.409 24.0854 256.618 25.8763 256.618 28.0854V31.4381C256.618 33.6472 258.409 35.4381 260.618 35.4381H291.855C294.064 35.4381 295.855 33.6472 295.855 31.4381V28.0854C295.855 25.8763 294.064 24.0854 291.855 24.0854Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_upper_5" d="M437.495 31.2646C439.617 32.271 440.364 34.9002 439.132 36.9003L435.097 43.4516C433.961 45.296 431.565 45.8967 429.667 44.851C401.922 29.5601 370.582 21.5023 338.67 21.5023H323.93C321.721 21.5023 319.93 19.7115 319.93 17.5023V14.8213C319.93 12.6121 321.721 10.8213 323.93 10.8213H346.368C378.951 10.8213 409.839 18.1524 437.495 31.2646Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_upper_6" d="M428.119 46.9543C430.093 48.0383 430.725 50.5564 429.544 52.474L427.393 55.9665C426.27 57.7903 423.912 58.4017 422.02 57.3964C395.655 43.384 365.604 35.4381 333.723 35.4381H323.93C321.721 35.4381 319.93 33.6472 319.93 31.4381V28.0854C319.93 25.8763 321.721 24.0854 323.93 24.0854H338.67C370.03 24.0854 400.845 31.977 428.119 46.9543Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_lower_1" d="M217.061 38.0766C219.275 38.0224 221.075 39.8198 221.075 42.0341V59.4151C221.075 61.6182 219.292 63.4014 217.09 63.4637C192.901 64.148 170.041 70.1996 149.649 80.4697C147.728 81.437 145.372 80.7738 144.289 78.9163L135.501 63.8567C134.362 61.9045 135.063 59.393 137.075 58.3627C161.186 46.0149 188.323 38.7804 217.061 38.0766Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_lower_2" d="M324.402 38.021H227.658C225.449 38.021 223.658 39.8119 223.658 42.021V59.3998C223.658 61.6089 225.449 63.3998 227.658 63.3998H324.402C326.611 63.3998 328.402 61.609 328.402 59.3998V42.021C328.402 39.8119 326.611 38.021 324.402 38.021Z" fill="#D0D7E1"></path>
            <path id="grandStand_pavillionBuilding_lower_3" d="M420.369 59.4321C422.383 60.4953 423.045 63.0423 421.851 64.9819L412.148 80.748C411.022 82.5783 408.653 83.1867 406.756 82.1767C384.263 70.2012 358.597 63.3998 331.386 63.3998V63.3998C331.165 63.3998 330.985 63.2206 330.985 62.9994V40.7591C330.985 39.2469 332.211 38.021 333.723 38.021V38.021C364.989 38.021 394.477 45.7647 420.369 59.4321Z" fill="#D0D7E1"></path>
            <path id="clubHouseNorthSaheedJewelStand_tuv_1" d="M543.726 142.992C544.588 145.078 543.505 147.446 541.377 148.202L514.646 157.703C512.582 158.436 510.317 157.372 509.515 155.334C494.239 116.509 466.466 83.936 431.179 62.5879C429.25 61.4204 428.609 58.9061 429.791 56.9854L441.782 37.5083C442.878 35.728 445.162 35.0886 447.004 36.0776C490.367 59.3589 524.792 97.181 543.726 142.992Z" fill="#D0D7E1"></path>
            <path id="clubHouseNorthSaheedJewelStand_tuv_2" d="M507.036 156.106C507.854 158.18 506.764 160.5 504.663 161.246L486.229 167.788C484.161 168.522 481.893 167.451 481.089 165.41C468.281 132.93 445.198 105.6 415.868 87.4265C413.961 86.2449 413.331 83.7455 414.506 81.8344L424.241 65.999C425.374 64.1558 427.77 63.5439 429.622 64.6615C464.484 85.6929 491.93 117.816 507.036 156.106Z" fill="#D0D7E1"></path>
            <path id="internationalGalleryNorth_rs_lower" d="M519.951 224.249C519.951 242.524 517.308 260.188 512.383 276.881C511.747 279.034 509.434 280.19 507.312 279.459L488.732 273.054C486.689 272.35 485.58 270.153 486.169 268.074C490.123 254.135 492.234 239.437 492.234 224.249C492.234 207.189 489.564 190.748 484.621 175.312C483.95 173.217 485.035 170.947 487.109 170.212L505.588 163.657C507.671 162.919 509.963 164.008 510.655 166.107C516.687 184.401 519.951 203.958 519.951 224.249Z" fill="#D0D7E1"></path>
            <path id="northernGallery_opq_1" d="M543.558 294.687C545.663 295.414 546.773 297.722 545.983 299.805C526.412 351.356 487.406 393.415 437.97 417.01C436.086 417.909 433.838 417.166 432.825 415.341L421.973 395.782C420.878 393.808 421.635 391.323 423.618 390.245C464.135 368.225 495.732 331.798 511.498 287.899C512.25 285.807 514.535 284.677 516.637 285.402L543.558 294.687Z" fill="#D0D7E1"></path>
            <path id="northernGallery_opq_2" d="M506.619 281.955C508.695 282.67 509.81 284.927 509.069 286.993C493.502 330.392 462.236 366.392 422.163 388.103C420.263 389.132 417.9 388.413 416.852 386.522L407.892 370.362C406.803 368.399 407.546 365.929 409.505 364.835C443.401 345.916 469.781 315.114 482.965 278.1C483.714 275.997 486.007 274.853 488.118 275.58L506.619 281.955Z" fill="#D0D7E1"></path>
            <path id="easternGallery_ijklmn_1" d="M430.118 415.816C431.259 417.873 430.388 420.468 428.217 421.373C403.004 431.882 375.349 437.689 346.368 437.689H213.222C183.168 437.689 154.557 431.45 128.595 420.179C126.5 419.27 125.641 416.774 126.689 414.745L135.923 396.866C136.926 394.924 139.301 394.151 141.278 395.084C165.684 406.612 192.924 413.06 221.656 413.06H333.723C362.496 413.06 389.785 406.582 414.218 395.022C416.153 394.107 418.479 394.826 419.517 396.698L430.118 415.816Z" ></path>
            <path id="easternGallery_ijklmn_2" d="M414.393 387.433C415.498 389.426 414.719 391.942 412.657 392.911C388.669 404.182 361.919 410.476 333.724 410.476H221.656C193.392 410.476 166.589 404.15 142.561 392.834C140.541 391.883 139.746 389.441 140.771 387.457L148.764 371.983C149.766 370.044 152.136 369.271 154.116 370.192C174.681 379.767 197.584 385.11 221.721 385.11H331.386C355.966 385.11 379.283 379.57 400.14 369.653C402.081 368.73 404.42 369.445 405.463 371.325L414.393 387.433Z" ></path>
            <path id="shaheedAbuSayedStand_fgh_1" d="M131.892 390.316C133.835 391.37 134.609 393.781 133.595 395.746L124.185 413.957C123.197 415.87 120.868 416.66 118.938 415.706C61.1275 387.116 18.0348 333.098 4.3823 268.363C3.9204 266.173 5.38966 264.053 7.59578 263.675L32.1334 259.465C34.2898 259.095 36.3395 260.53 36.784 262.672C48.2217 317.805 83.7798 364.22 131.892 390.316Z" fill="#D0D7E1"></path>
            <path id="shaheedAbuSayedStand_fgh_2" d="M144.734 365.459C146.674 366.521 147.447 368.932 146.432 370.896L138.443 386.352C137.43 388.313 135.016 389.086 133.076 388.032C85.7131 362.306 50.6837 316.628 39.3531 262.353C38.8972 260.169 40.3663 258.063 42.5651 257.685L59.757 254.736C61.9095 254.367 63.9554 255.795 64.4122 257.93C74.3285 304.289 104.285 343.315 144.734 365.459Z" fill="#D0D7E1"></path>
          </g>
        </g>
        <defs>
          <clipPath id="clip0_4286_52860">
            <rect width="560" height="450" fill="white"></rect>
          </clipPath>
          <clipPath id="clip1_4286_52860">
            <rect width="560" height="450" fill="white"></rect>
          </clipPath>
        </defs>
      </svg>
    </div>
  );
};
